<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thread Milling</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />
  <style>
    textarea {
      height: 400px;
    }

    .site-footer {
      background: #3f474b;
      color: #e9ecef
    }

    .site-footer .footer-topbar {
      height: 10px;
      background: #c7c7c7
    }

    .site-footer a {
      color: #e9f2ff
    }

    .site-footer a:hover {
      text-decoration: underline
    }

    .footer-logo {
      height: 72px;
      display: block;
      margin-inline: auto
    }

    @media (min-width:1200px) {
      .footer-logo {
        height: 80px
      }
    }

    .badge-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: .35rem .5rem;
      justify-content: center
    }

    .badge-row img {
      height: 48px
    }

    .duns-img {
      height: 60px;
      max-width: 100%
    }

    .footer-underline {
      height: 2px;
      width: 100%;
      background: rgba(255, 255, 255, .35);
      margin: .4rem 0 1rem
    }

    @media (max-width:991.98px) {
      .site-footer .row>[class*="col-"] {
        text-align: center
      }
    }
  </style>
</head>

<body>
  <div class="container my-3">
    <h1 class="mb-4 my-3 d-flex align-items-center">
      <img src="https://nine9.jic-tools.com.tw/themes/nine9/images/logo.png" alt="Logo" height="100"
        style="margin-right:10px;">
      <strong class="fw-bold">NC Program Generator for Thread Milling</strong>
    </h1>

    <hr class="my-4" />
    <div class="row">
      <div class="col-md-7">
        <div class="row g-3">

          <!-- Thread mode -->
          <div class="col-md-4 my-3 fw-bold">
            <label class="form-label">Thread Type</label>
            <select class="form-select" id="threadMode" onchange="onModeChange()">
              <option value="" disabled selected>Select thread type</option>
              <option value="parallel">Parallel thread</option>
              <option value="tapered">Tapered thread (PT / NPT)</option>
            </select>
          </div>

          <!-- Parallel families -->
          <div class="col-md-8 my-3 fw-bold" id="parallelWrap" style="display:none;">
            <label class="form-label">Parallel Family</label>
            <select class="form-select" id="selectParallelFamily" onchange="updateInsertList()">
              <option value="" disabled selected>Select parallel family</option>
              <option value="parallel60">60° Parallel Thread: such as Metric thread.</option>
              <option value="parallel55">55° Parallel Pipe Thread: ISO/JIS-G, PF, Rp, PS; BSPP</option>
            </select>
          </div>

          <!-- Taper families -->
          <div class="col-md-8 my-3 fw-bold" id="taperWrap" style="display:none;">
            <label class="form-label">Taper Family</label>
            <select class="form-select" id="selectTaper" onchange="updateInsertList()">
              <option value="" disabled selected>Select thread family</option>
              <option value="55">55° Tapered Pipe Thread: ISO/JIS-R / PT / Rc / BSPT</option>
              <option value="60">60° Tapered Thread: NPT</option>
            </select>
          </div>

          <hr class="my-4" />

          <!-- Thread hand -->
          <!-- <div class="col-6 col-md-4 fw-bold">
            <label class="form-label">Thread Hand</label>
            <select class="form-select" id="threadHand">
              <option value="" disabled selected>Select hand</option>
              <option value="RH">Right-hand (RH)</option>
              <option value="LH">Left-hand (LH)</option>
            </select>
          </div> -->

          <!-- NEW: Thread Series (only for parallel60) -->
          <div class="col-6 col-md-4 fw-bold" id="seriesWrap" style="display:none;">
            <label class="form-label">Thread Series</label>
            <select class="form-select" id="threadSeries" onchange="onSeriesChange()">
              <option value="" selected disabled>Select series</option>
              <option value="M">M (Metric coarse)</option>
              <option value="MF">MF (Metric fine)</option>
              <!-- <option value="HC">STI (Wire Thread Insert)</option> -->
              <option value="UNC">UNC</option>
              <option value="UNF">UNF</option>
              <option value="UNEF">UNEF</option>
            </select>
          </div>


          <!-- Thread size -->
          <div class="col-6 col-md-4 fw-bold">
            <label class="form-label">Thread Size</label>
            <select class="form-select" id="selectThreadSize" onchange="onThreadSizeChange()">
              <option value="" disabled selected>Select thread size</option>
            </select>
          </div>

          <!-- Insert + material -->
          <div class="col-6 col-md-4 my-3 fw-bold">
            <label class="form-label">Select Insert</label>
            <select class="form-select" id="selectTool" onchange="onInsertChange()">
              <option value="" disabled selected>Select Insert</option>
            </select>
          </div>

          <div class="col-12 col-md-4 my-3 fw-bold">
            <label class="form-label">Workpiece material</label>
            <select class="form-select" id="selectMaterial" onchange="updateCuttingSpeed(); updateSelectColor()">
              <option value="" disabled selected>Select material</option>
              <option value="Material01" style="background-color:#0066CC; color:white; font-weight:bold;">Carbon steel
              </option>
              <option value="Material04" style="background-color:#0066CC; color:white; font-weight:bold;">Alloy steel
              </option>
              <option value="Material06" style="background-color:#FFC000; font-weight:bold;">Stainless steel</option>
              <option value="Material07" style="background-color:#FF0000; color:white; font-weight:bold;">Cast iron
              </option>
              <option value="Material08" style="background-color:#00B050; color:white; font-weight:bold;">Non-ferrous
                metal</option>
              <option value="Material12" style="background-color:#A6A6A6; font-weight:bold;">Hardened steel &lt; HRC50
              </option>
            </select>
          </div>

          <hr class="my-4" />

          <!-- Cutting params -->
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Insert Diameter</label>
            <input type="text" class="form-control bg-light" id="toolDiameter" readonly style="cursor:not-allowed;"
              placeholder="Select Insert/mm" oninput="updateSpindleSpeed()">
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Cutting Speed</label>
            <input type="number" class="form-control" id="vc" placeholder="m/min" oninput="updateSpindleSpeed()" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Spindle Speed</label>
            <input type="number" class="form-control" id="n" placeholder="RPM" readonly
              style="background-color:#d4edda; cursor:not-allowed;" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Number of Teeth</label>
            <input type="number" class="form-control bg-light" style="cursor:not-allowed;" id="z" value="6" readonly
              oninput="updateFeedRate()" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Feed per Tooth</label>
            <input type="number" class="form-control" id="fz" placeholder="mm/tooth" step="0.001"
              oninput="updateFeedRate()" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Feed Rate</label>
            <input type="number" class="form-control" id="vf" placeholder="mm/min" readonly
              style="background-color:#d4edda; cursor:not-allowed;" />
          </div>

          <hr class="my-4" />

          <!-- Thread geometry -->
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Outer-Dia</label>
            <input type="number" class="form-control" id="od" placeholder="mm" step="0.001" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Tap Drill Diameter</label>
            <input type="number" class="form-control" id="tapDrill" placeholder="mm" step="0.001" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Thread Pitch</label>
            <input type="number" class="form-control" id="pitch" placeholder="mm" step="0.001" />
          </div>
          <div class="col-md-12 fw-bold">
            <label class="form-label">Thread Details</label>
            <textarea id="threadInfo" class="form-control" style="max-height:110px; overflow-y:auto;"
              readonly></textarea>
          </div>

          <hr class="my-4" />

          <!-- Passes -->
          <div class="col-md-6 fw-bold">
            <label class="form-label">Number Of Passes</label>
            <select class="form-select" id="passes" onchange="updatePassInputs()">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="col-12 fw-bold">
            <div class="row" id="passInputs"></div>
          </div>

          <hr class="my-4" />

          <!-- Misc -->
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Depth of Cut</label>
            <input type="number" class="form-control" id="depth" value="16" step="0.001" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Tool Number</label>
            <input type="number" class="form-control" id="toolNo" value="99" />
          </div>
          <div class="col-6 col-md-4 fw-bold text-center">
            <label class="form-label">Coordinate System</label>
            <input type="text" class="form-control" id="gcode" value="G54" />
          </div>

          <hr class="my-4" />

          <!-- Coordinates -->
          <div class="col-6 col-md-3 fw-bold text-center">
            <label class="form-label">Coordinate X</label>
            <input type="number" class="form-control" id="x" value="0" />
          </div>
          <div class="col-6 col-md-3 fw-bold text-center">
            <label class="form-label">Coordinate Y</label>
            <input type="number" class="form-control" id="y" value="0" />
          </div>
          <div class="col-6 col-md-3 fw-bold text-center">
            <label class="form-label">Safe Height Z</label>
            <input type="number" class="form-control" id="zsafe" value="20" />
          </div>
          <div class="col-6 col-md-3 fw-bold text-center">
            <label class="form-label">Surface Coordinate Z</label>
            <input type="number" class="form-control" id="zsurface" value="0" />
          </div>

          <hr class="my-4" />
        </div>
      </div>

      <div class="col-md-5">
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-secondary me-2 fw-bold" onclick="addTool(); countClick('addTool')">Add Tool</button>
          <button class="btn btn-primary me-2 fw-bold"
            onclick="calculateGCode(); countClick('calculate')">Generate</button>
          <button class="btn btn-success me-2 fw-bold" onclick="exportToFile(); countClick('export')">Export</button>
          <button class="btn btn-danger fw-bold" onclick="clearOutput(); countClick('clear')">Clear</button>
        </div>
        <textarea id="result" class="form-control my-3" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- footer -->
  <footer class="site-footer mt-5">
    <div class="footer-topbar"></div>
    <div class="container py-5">
      <div class="row gy-4 align-items-start">
        <div class="col-12 col-md-6 col-lg-3 text-center">
          <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer_logo.png"
            alt="JIMMORE" class="footer-logo mb-3 mx-auto d-block">
          <div class="badge-row mb-3">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_01.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_02.png"
              alt="SGS">
            <img src="https://nine9.jic-tools.com.tw/upload_files/technology/NC_Program/Jimmore_footer-iso_03.png"
              alt="UKAS">
          </div>
          <a href="#" target="_blank" rel="noopener">
            <img src="https://www.jic-tools.com.tw/themes/jictools2/images/Jimmore-footer-iso_2.png"
              alt="D-U-N-S Certified" class="duns-img">
          </a>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <address class="mb-0 small lh-lg">
            No.120-2, Sec-2 Fusing Rd., South District,<br>Taichung City 402014, Taiwan
          </address>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            TEL: <a href="tel:+886422605352" class="link-light text-decoration-none">+886-4-22605352</a><br>
            FAX: +886-4-22608765<br>
            E-mail: <a href="mailto:trade@jimmore.com.tw"
              class="link-light text-decoration-none">trade@jimmore.com.tw</a>
          </p>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="footer-underline"></div>
          <p class="small mb-2">
            Copyright © <span id="year"></span> Jimmore International Corp.<br>
            All Rights Reserved.
          </p>
          <ul class="list-unstyled small mb-0"></ul>
        </div>
      </div>
    </div>
    <script>document.getElementById('year').textContent = (new Date()).getFullYear();</script>
  </footer>

  <!-- helpers -->
  <script>
    function updateSelectColor() {
      const select = document.getElementById("selectMaterial");
      const opt = select.options[select.selectedIndex];
      select.style.backgroundColor = opt?.style?.backgroundColor || '';
      select.style.color = opt?.style?.color || '';
    }
    function countClick() { } // no-op
  </script>

  <!-- materials (vc / fz presets per material) -->
  <script>
    const cuttingSpeedMap = {
      Material01: { vc: 60.0, fz: 0.005 },
      Material04: { vc: 45.0, fz: 0.005 },
      Material06: { vc: 45.0, fz: 0.005 },
      Material07: { vc: 50.0, fz: 0.005 },
      Material08: { vc: 120.0, fz: 0.0005 },
      Material12: { vc: 30.0, fz: 0.004 }
    };
    function updateCuttingSpeed() {
      const m = document.getElementById("selectMaterial").value;
      const vc = document.getElementById("vc");
      const fz = document.getElementById("fz");
      const d = cuttingSpeedMap[m];
      if (d) { vc.value = d.vc; fz.value = d.fz; updateSpindleSpeed(); }
      else { vc.value = ""; fz.value = ""; }
    }
  </script>

  <!-- core UI logic -->
  <script>
    function updatePassInputs() {
      const passCount = parseInt(document.getElementById("passes").value);
      const container = document.getElementById("passInputs");
      container.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        if (i < passCount) {
          const col = document.createElement("div");
          col.className = "col-md-2 text-center";
          const label = document.createElement("label");
          label.className = "form-label";
          const suffix = ["st", "nd", "rd", "th", "th"][i];
          label.textContent = `${i + 1}${suffix} Pass`;
          const input = document.createElement("input");
          input.type = "text"; input.className = "form-control text-center"; input.id = `pass${i + 1}`;
          if (i === passCount - 1) { input.value = "100%"; input.readOnly = true; }
          else { input.value = "%"; input.placeholder = "%"; input.readOnly = false; }
          col.appendChild(label); col.appendChild(input); container.appendChild(col);
        }
      }
    }

    function updateSpindleSpeed() {
      const d = parseFloat(document.getElementById("toolDiameter").value);
      const vc = parseFloat(document.getElementById("vc").value);
      if (!isNaN(d) && d > 0 && !isNaN(vc) && vc > 0) {
        const n = (1000 * vc) / (Math.PI * d);
        document.getElementById("n").value = n.toFixed(0);
      } else {
        document.getElementById("n").value = "";
      }
      updateFeedRate();
    }

    function updateFeedRate() {
      const z = parseFloat(document.getElementById("z").value);
      const fz = parseFloat(document.getElementById("fz").value);
      const n = parseFloat(document.getElementById("n").value);
      if (!isNaN(z) && !isNaN(fz) && !isNaN(n) && z > 0 && fz > 0 && n > 0) {
        const vf = n * fz * z;
        document.getElementById("vf").value = vf.toFixed(2);
      } else {
        document.getElementById("vf").value = "";
      }
    }

    function addTool() {
      const toolNo = document.getElementById("toolNo").value;
      const spindleSpeed = document.getElementById("n").value;
      const gcode = `G17 G21 G49 G80\nT${toolNo} M06\nS${spindleSpeed} M03\nM08\n`;
      document.getElementById("result").value += gcode + "\n";
    }
    function clearOutput() { document.getElementById("result").value = ""; }
    function exportToFile() {
      let content = document.getElementById("result").value;
      content += `\nM05\nM09\nG91 G28 Z0.\nG91 G28 Y0.\nM30`;
      const blob = new Blob([content], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ThreadMilling_NCCode.txt"; a.click();
    }
  </script>

  <!-- depth helpers -->
  <script>
    // 無條件進位到指定小數
    function ceilTo(val, decimals = 3) { const f = Math.pow(10, decimals); return Math.ceil(val * f) / f; }

    // >>> 深度帶入規則 <<<
    // A) 資料庫有 DepthOfCut/DepthofCut -> 直接用
    // B) 名稱（或其底層公制名）是 M 開頭，且有 MajorDiameter -> 用 "Major × 2"
    // C) 其餘 -> 無條件進位到 0.001 的 (Pitch × 5)

    function getDepthPresetForThread(name, data) {
      if (data && (data.DepthOfCut != null || data.DepthofCut != null))
        return Number(data.DepthOfCut ?? data.DepthofCut);

      // const metricName = baseMetricOf(name); // 由外部檔提供
      // if (/^M\b/ || /^MF\b/ || /^UNC\b/ || /^UNF\b/ || /^UNEF\b/i.test(metricName) && data?.MajorDiameter)
      //   return Number(data.MajorDiameter) * 2;

      const metricName = baseMetricOf(name); // 由外部檔提供
      if (/^M\b/i.test(metricName) && data?.MajorDiameter)
        return Number(data.MajorDiameter) * 2;

      return null;
    }

    function updateDepthAuto() {
      const sizeSel = document.getElementById('selectThreadSize');
      const size = sizeSel?.value || '';
      const data = getThreadDataForKey(size); // 外部檔提供（含 HC 回退）
      const depthEl = document.getElementById('depth');

      const preset = getDepthPresetForThread(size, data);
      if (preset != null) { depthEl.value = Number(preset).toFixed(3); return; }

      const p = parseFloat(document.getElementById('pitch').value);
      if (!isNaN(p) && p > 0) { depthEl.value = ceilTo(p * 10, 3).toFixed(3); }
    }
  </script>

  <!-- calculators (G-code) -->
  <script>
    function parsePassPercent(i) {
      const el = document.getElementById(`pass${i}`);
      if (!el) return 100;
      const t = (el.value || '').replace('%', '').trim();
      if (t === '') return 100;
      const p = Number(t);
      if (isNaN(p) || p <= 0 || p > 100) throw new Error(`第 ${i} 刀路深度百分比格式錯誤`);
      return p;
    }

    function calculateGCode() {
      try {
        const gcode = (document.getElementById('gcode').value || 'G54').toUpperCase();
        const Xc = Number(document.getElementById('x').value) || 0;
        const Yc = Number(document.getElementById('y').value) || 0;
        const Zsafe = Number(document.getElementById('zsafe').value) || 20;
        const Zsurf = Number(document.getElementById('zsurface').value) || 0;
        const H = Number(document.getElementById('toolNo').value) || 99;

        const rpm = Number(document.getElementById('n').value);
        const fz = Number(document.getElementById('fz').value);
        const teeth = Number(document.getElementById('z').value) || 6;
        const feed = (!isNaN(rpm) && !isNaN(fz)) ? rpm * fz * teeth : null;

        const toolDia = Number(document.getElementById('toolDiameter').value);
        if (!toolDia || toolDia <= 0) throw new Error('缺少刀徑 (Insert Diameter)');

        const OD = Number(document.getElementById('od').value);
        const pitch = Number(document.getElementById('pitch').value);
        const tapDrill = Number(document.getElementById('tapDrill').value);
        if (isNaN(OD)) throw new Error('請提供外徑 (OD)');
        if (isNaN(pitch)) throw new Error('請提供螺距 (Pitch)');
        if (isNaN(tapDrill)) throw new Error('請提供 Tap Drill Diameter');

        const depth = Number(document.getElementById('depth').value) || 10;
        if (depth <= 0) throw new Error('Depth of Cut 必須 > 0');

        const passCount = parseInt(document.getElementById('passes').value) || 1;

        const sizeEl = document.getElementById('selectThreadSize');
        const threadSize = (sizeEl && sizeEl.value) ? sizeEl.value :
          (sizeEl && sizeEl.selectedIndex > -1 ? sizeEl.options[sizeEl.selectedIndex].text : '');

        const handEl = document.getElementById('threadHand');
        const threadHand = (handEl && handEl.value) ? handEl.value :
          (handEl && handEl.selectedIndex > -1 ? handEl.options[handEl.selectedIndex].text : '');

        const header = [
          `(Thread Size: ${threadSize || 'N/A'})`,
          // `(Thread Hand: ${threadHand || 'N/A'})`,
          `G90 ${gcode} G00 X${Xc.toFixed(3)} Y${Yc.toFixed(3)}`,
          `G43 H${H} Z${Zsafe.toFixed(3)}`
        ];

        const mode = document.getElementById('threadMode')?.value || 'parallel';
        let body;
        if (mode === 'tapered') {
          body = genTapered({ Xc, Yc, Zsafe, Zsurf, feed, toolDia, OD, pitch, tapDrill, depth, passCount });
        } else {
          body = genParallel({ Xc, Yc, Zsafe, Zsurf, feed, toolDia, OD, pitch, tapDrill, depth, passCount });
        }
        document.getElementById("result").value += header.concat(body).join('\n') + '\n';
      } catch (err) {
        alert("計算錯誤：" + err.message);
      }
    }

    // Tapered (PT/NPT)
    function genTapered({ Xc, Yc, Zsafe, Zsurf, feed, toolDia, OD, pitch, tapDrill, depth, passCount }) {
      const out = [];
      const P = pitch, stepDeg = 10, liftZ = 1.5 * P, dR_per_rev = P / 32;
      const R_finish = (OD - toolDia) / 2, R_start = (tapDrill - toolDia) / 2;
      if (R_finish <= 0) throw new Error('外徑需大於刀徑');
      if (R_start < 0) throw new Error('Tap Drill 需大於刀徑');

      for (let i = 1; i <= passCount; i++) {
        const percent = parsePassPercent(i);
        const R_base = R_start + (R_finish - R_start) * (percent / 100);
        const R_entry = R_base + (P / 32) * 1.5;
        out.push(`G90 G00 X${(Xc + R_entry).toFixed(3)} Y${(Yc + 0).toFixed(3)} Z${(Zsurf + liftZ).toFixed(3)}`);

        let ang = 0, once = true, lastR = R_entry, loop = 0;
        while (true) {
          ang += stepDeg;
          const rev = ang / 360;
          const zOff = (-P) * rev + liftZ;
          const Rnow = R_entry - dR_per_rev * rev;
          const xOff = Math.cos(ang * Math.PI / 180) * Rnow;
          const yOff = -Math.sin(ang * Math.PI / 180) * Rnow;
          const X = (Xc + xOff).toFixed(3), Y = (Yc + yOff).toFixed(3), Z = (Zsurf + zOff).toFixed(3);
          out.push(`G02 X${X} Y${Y} Z${Z} R${Rnow.toFixed(3)}${(feed && once) ? ` F${feed.toFixed(1)}` : ''}`);
          once = false; lastR = Rnow;
          if (Math.abs(zOff) >= depth) break;
          if (++loop > 20000) throw new Error('Angle 迴圈過多，請檢查參數');
        }
        out.push(`G02 X${Xc.toFixed(3)} Y${Yc.toFixed(3)} R${(lastR * 0.501).toFixed(3)}`);
        out.push(`G01 Z${Zsurf.toFixed(3)} F1500.`);
        out.push(`G00 Z${Zsafe.toFixed(3)}`);
      }
      return out;
    }

    // Parallel
    function genParallel({ Xc, Yc, Zsafe, Zsurf, feed, toolDia, OD, pitch, tapDrill, depth, passCount }) {
      const out = [];
      const turns = Math.ceil(depth / pitch);
      const R_tap = (tapDrill - toolDia) / 2;
      const R_fin = (OD - toolDia) / 2;
      if (R_fin <= 0) throw new Error('外徑需大於刀徑');
      if (R_tap < 0) throw new Error('Tap Drill 需大於刀徑');

      for (let i = 1; i <= passCount; i++) {
        const percent = parsePassPercent(i);
        const R_work = R_tap + (R_fin - R_tap) * (percent / 100);

        let Z = Zsurf - depth;
        out.push(`G01 Z${Z.toFixed(3)}${feed ? ` F${feed.toFixed(1)}` : ''}`);
        out.push(`G03 X${(Xc + R_work).toFixed(3)} Y${Yc.toFixed(3)} R${(R_work * 0.501).toFixed(3)}`);

        for (let k = 0; k < turns; k++) {
          Z += pitch;
          out.push(`G03 I-${R_work.toFixed(3)} Z${Z.toFixed(3)}`);
        }

        out.push(`G03 X${Xc.toFixed(3)} Y${Yc.toFixed(3)} R${(R_work * 0.501).toFixed(3)}`);
        out.push(`G00 Z${Zsafe.toFixed(3)}`);
      }
      return out;
    }
  </script>

  <!-- 外部：Thread/Tool/Series/DB -->
  <!-- <script src="./thread-tool-db.js"></script> -->
  <script>/* =========================
Thread & Tool DB + 選刀/系列邏輯（抽離版）
用途：
- 提供刀具群組、刀具↔尺寸映射、刀徑查詢
- 提供螺紋資料庫 threadData（含 PT/NPT/G、公制、英制、HC 覆寫）
- 提供系列（M/MF/HC）判定與清單過濾
- 提供 UI 下拉（Family/Series/Size/Insert）的更新方法
- 提供 getThreadDataForKey / updateThreadFields 等查值與帶欄位方法
========================= */

    /* ---------- 小工具 ---------- */
    const P_tpi = tpi => Number((25.4 / tpi).toFixed(3));  // 將英制 TPI 轉螺距（mm）用於 PT/NPT

    // 取得「去掉 HC/Heli-Coil 前綴」的公制名（for HC 還原到底層公制用）
    function baseMetricOf(s) {
      return s.replace(/^(HC|Heli[\s-]?Coil)[\s-]*/i, '').trim();  // 同時處理 "HC "、"HC-"、"Heli-Coil "
    } // 用意：HC 顯示名 → 查公制資料 / insert 相容性

    // 產生 HC 顯示名
    function hcOf(s) {
      return `HC ${baseMetricOf(s)}`;  // 統一 HC 顯示為「HC M...」
    } // 用意：在 UI 以 HC 系列顯示對應的公制尺寸

    // 是否為公制尺寸（包含 M 與 MF，且允許帶 HC 前綴）
    function isMetricSize(s) {
      return /^(?:M|MF)\b/i.test(baseMetricOf(s));  // 先剝掉 HC，再檢查 M/MF
    } // 用意：過濾出可做 HC 的基礎（仍是 60° 公制牙形）

    /* ---------- 刀具群組與刀徑 ---------- */
    const toolGroups = {
      // 平行 60°（公制/UN）
      parallel60: [
        { v: 'R06005-05006', t: 'R06005-05006' },
        { v: 'R06005-05010', t: 'R06005-05010' },
        { v: 'R06007-06810', t: 'R06007-06810' },
        { v: 'R06010-08510', t: 'R06010-08510' },
        { v: 'R06010-10010', t: 'R06010-10010' },
      ],
      // 平行 55°（G/PF）
      parallel55: [
        { v: 'R05507-06512', t: 'R05507-06512' },
        { v: 'R05510-10018', t: 'R05510-10018' },
      ],
      // 錐牙：PT / NPT
      tapered55: [{ v: 'R05510-09516', t: 'R05510-09516' }, { v: 'R05510-10025', t: 'R05510-10025' }],
      tapered60: [{ v: 'R06010-09808', t: 'R06010-09808' }, { v: 'R06010-10810', t: 'R06010-10810' }]
    }; // 用意：依「Thread Type → Family」決定有哪些可選 insert

    function getDcFromTool(code) {
      const map = {
        // parallel
        'R05507-06512': 6.56, 'R05510-10018': 10.0,
        'R06005-05006': 5.0, 'R06005-05010': 5.0,
        'R06007-06810': 6.8, 'R06010-08510': 8.5,
        'R06010-10010': 10.0,
        // tapered
        'R05510-09516': 9.5, 'R05510-10025': 10.0,
        'R06010-09808': 9.8, 'R06010-10810': 10.8
      };
      return map[code] ?? 0;   // 回傳刀徑 Dc（mm）；0 代表未知
    } // 用意：由 insert 型號自動帶出刀徑供計算轉速

    /* ---------- 刀具支援尺寸（Insert → Sizes） ---------- */
    const toolThreadMap = {
      // tapered
      'R05510-09516': ['PT 1/4', 'PT 3/8'],
      'R05510-10025': ['PT 1/2', 'PT 3/4'],
      'R06010-09808': ['NPT 1/4', 'NPT 3/8'],
      'R06010-10810': ['NPT 1/2', 'NPT 3/4'],
      // parallel 55° (G/PF)
      'R05507-06512': ['G (PF) 1/16', 'G (PF) 1/8'],
      'R05510-10018': ['G (PF) 1/4', 'G (PF) 3/8', 'G (PF) 1/2', 'G (PF) 5/8', 'G (PF) 3/4', 'G (PF) 7/8'],
      // parallel 60° (Metric/UN)
      'R06005-05006': ['MF 6 x 0.75', 'MF 7 x 0.75', 'MF 8 x 0.75', 'MF 9 x 0.75', 'MF 10 x 0.75', 'MF 11 x 0.75',
        'UNF 1/4-28', 'UNEF 1/4-32', 'UNEF 5/16-32', 'UNEF 3/8-32', 'UNEF 7/16-28', 'UNEF 1/2-28'],
      'R06005-05010': ['M 6 x 1.0', 'M 7 x 1.0', 'MF 8 x 1.0', 'MF 9 x 1.0', 'MF 10 x 1.0', 'MF 11 x 1.0', 'MF 12 x 1.0',
        'MF 14 x 1.0', 'MF 15 x 1.0', 'MF 16 x 1.0', 'MF 17 x 1.0', 'MF 18 x 1.0', 'MF 20 x 1.0',
        'MF 22 x 1.0', 'MF 24 x 1.0', 'MF 25 x 1.0', 'MF 27 x 1.0', 'MF 28 x 1.0', 'MF 33 x 1.0',
        'UNF 1/4-28', 'UNF 5/16-24', 'UNF 3/8-24', 'UNEF 7/16-28', 'UNEF 1/2-28', 'UNEF 9/16-24',
        'UNEF 5/8-24', 'UNEF 11/16-24'],
      'R06007-06810': ['M 8 x 1.25', 'M 9 x 1.25', 'MF 8 x 1.0', 'MF 9 x 1.0', 'MF 10 x 1.0', 'MF 10 x 1.25', 'MF 11 x 1.0',
        'MF 12 x 1.0', 'MF 12 x 1.25', 'MF 14 x 1.0', 'MF 14 x 1.25', 'MF 15 x 1.0', 'MF 16 x 1.0',
        'MF 17 x 1.0', 'MF 18 x 1.0', 'MF 20 x 1.0', 'MF 22 x 1.0', 'MF 24 x 1.0', 'MF 25 x 1.0',
        'MF 27 x 1.0', 'MF 28 x 1.0', 'MF 33 x 1.0', 'UNF 5/16-24', 'UNF 3/8-24', 'UNF 7/16-20',
        'UNF 1/2-20', 'UNEF 7/16-28', 'UNEF 1/2-28', 'UNEF 9/16-24', 'UNEF 5/8-24', 'UNEF 11/16-24',
        'UNEF 3/4-20', 'UNEF 13/16-20', 'UNEF 7/8-20', 'UNEF 15/16-20', 'UNEF 1-20'],
      'R06010-08510': ['M 10 x 1.5', 'M 11 x 1.5', 'MF 10 x 1.0', 'MF 10 x 1.25', 'MF 11 x 1.0', 'MF 12 x 1.0',
        'MF 12 x 1.25', 'MF 12 x 1.5', 'MF 14 x 1.0', 'MF 14 x 1.25', 'MF 14 x 1.5', 'MF 15 x 1.0',
        'MF 15 x 1.5', 'MF 16 x 1.0', 'MF 16 x 1.5', 'MF 17 x 1.0', 'MF 17 x 1.5', 'MF 18 x 1.0',
        'MF 18 x 1.5', 'MF 20 x 1.0', 'MF 20 x 1.5', 'MF 22 x 1.0', 'MF 22 x 1.5', 'MF 24 x 1.0',
        'MF 24 x 1.5', 'MF 25 x 1.0', 'MF 25 x 1.5', 'MF 27 x 1.0', 'MF 27 x 1.5', 'MF 28 x 1.0',
        'MF 28 x 1.5', 'MF 30 x 1.5', 'MF 32 x 1.5', 'MF 33 x 1.0', 'MF 33 x 1.5', 'MF 35 x 1.5',
        'MF 36 x 1.5', 'MF 39 x 1.5', 'MF 40 x 1.5', 'MF 42 x 1.5', 'MF 45 x 1.5', 'MF 48 x 1.5',
        'MF 50 x 1.5',
        'UNF 3/8-24', 'UNF 7/16-20', 'UNF 1/2-20', 'UNF 9/16-18', 'UNF 5/8-18',
        'UNEF 9/16-24', 'UNEF 5/8-24', 'UNEF 11/16-24', 'UNEF 3/4-20', 'UNEF 13/16-20', 'UNEF 7/8-20',
        'UNEF 15/16-20', 'UNEF 1-20', 'UNEF 1 1/16-18', 'UNEF 1 1/8-18', 'UNEF 1 3/16-18',
        'UNEF 1 1/4-18', 'UNEF 1 5/16-18', 'UNEF 1 3/8-18', 'UNEF 1 7/16-18', 'UNEF 1 1/2-18',
        'UNEF 1 9/16-18', 'UNEF 1 5/8-18', 'UNEF 1 11/16-18'],
      'R06010-10010': ['M 12 x 1.75', 'M 14 x 2.0', 'M 16 x 2.0',
        'MF 11 x 1.0', 'MF 12 x 1.0', 'MF 12 x 1.25', 'MF 12 x 1.5', 'MF 14 x 1.0', 'MF 14 x 1.25',
        'MF 14 x 1.5', 'MF 15 x 1.0', 'MF 15 x 1.5', 'MF 16 x 1.0', 'MF 16 x 1.5', 'MF 17 x 1.0',
        'MF 17 x 1.5', 'MF 18 x 1.0', 'MF 18 x 1.5', 'MF 18 x 2.0', 'MF 20 x 1.0', 'MF 20 x 1.5',
        'MF 20 x 2.0', 'MF 22 x 1.0', 'MF 22 x 1.5', 'MF 22 x 2.0', 'MF 24 x 1.0', 'MF 24 x 1.5',
        'MF 24 x 2.0', 'MF 25 x 1.0', 'MF 25 x 1.5', 'MF 25 x 2.0', 'MF 27 x 1.0', 'MF 27 x 1.5',
        'MF 27 x 2.0', 'MF 28 x 1.0', 'MF 28 x 1.5', 'MF 28 x 2.0', 'MF 30 x 1.5', 'MF 30 x 2.0',
        'MF 32 x 1.5', 'MF 32 x 2.0', 'MF 33 x 1.0', 'MF 33 x 1.5', 'MF 33 x 2.0', 'MF 35 x 1.5',
        'MF 36 x 1.5', 'MF 36 x 2.0', 'MF 39 x 1.5', 'MF 39 x 2.0', 'MF 40 x 1.5', 'MF 40 x 2.0',
        'MF 42 x 1.5', 'MF 42 x 2.0', 'MF 45 x 1.5', 'MF 45 x 2.0', 'MF 48 x 1.5', 'MF 48 x 2.0',
        'MF 50 x 1.5', 'MF 50 x 2.0', 'MF 52 x 2.0', 'MF 55 x 2.0', 'MF 56 x 2.0', 'MF 58 x 2.0',
        'MF 60 x 2.0', 'MF 62 x 2.0', 'MF 64 x 2.0', 'MF 65 x 2.0', 'MF 68 x 2.0', 'MF 70 x 2.0',
        'MF 72 x 2.0', 'MF 75 x 2.0', 'MF 76 x 2.0', 'MF 80 x 2.0',
        'UNC 1/2-13',
        'UNF 1/2-20', 'UNF 9/16-18', 'UNF 5/8-18', 'UNF 3/4-16', 'UNF 7/8-14',
        'UNEF 9/16-24', 'UNEF 5/8-24', 'UNEF 11/16-24', 'UNEF 3/4-20', 'UNEF 13/16-20', 'UNEF 7/8-20',
        'UNEF 15/16-20', 'UNEF 1-20', 'UNEF 1 1/16-18', 'UNEF 1 1/8-18', 'UNEF 1 3/16-18',
        'UNEF 1 1/4-18', 'UNEF 1 5/16-18', 'UNEF 1 3/8-18', 'UNEF 1 7/16-18', 'UNEF 1 1/2-18',
        'UNEF 1 9/16-18', 'UNEF 1 5/8-18', 'UNEF 1 11/16-18']
    }; // 用意：每顆 insert 能做哪些尺寸（供交互篩選）

    /* ---------- 螺紋資料庫 threadData ---------- */
    const threadData = {
      // PT / NPT
      "PT 1/4": { MajorDiameter: 13.157, Pitch: P_tpi(19), TapDrillDiameter: 11.113, DepthOfCut: 9.4 },   // PT 牙
      "PT 3/8": { MajorDiameter: 16.662, Pitch: P_tpi(19), TapDrillDiameter: 14.684, DepthOfCut: 9.7 },
      "PT 1/2": { MajorDiameter: 20.955, Pitch: P_tpi(14), TapDrillDiameter: 18.256, DepthOfCut: 12.7 },
      "PT 5/8": { MajorDiameter: 22.911, Pitch: P_tpi(14), TapDrillDiameter: 20.9, DepthOfCut: 13.4 },
      "PT 3/4": { MajorDiameter: 26.441, Pitch: P_tpi(14), TapDrillDiameter: 23.813, DepthOfCut: 14.1 },
      "PT 7/8": { MajorDiameter: 30.201, Pitch: P_tpi(14), TapDrillDiameter: 28.1, DepthOfCut: 15.2 },

      "NPT 1/4": { MajorDiameter: 13.716, Pitch: P_tpi(18), TapDrillDiameter: 11.113, DepthOfCut: 12 },   // NPT 牙
      "NPT 3/8": { MajorDiameter: 17.145, Pitch: P_tpi(18), TapDrillDiameter: 14.288, DepthOfCut: 12 },
      "NPT 1/2": { MajorDiameter: 21.336, Pitch: P_tpi(14), TapDrillDiameter: 17.859, DepthOfCut: 12 },
      "NPT 3/4": { MajorDiameter: 26.67, Pitch: P_tpi(14), TapDrillDiameter: 23.019, DepthOfCut: 12 },

      // G (BSPP) subset
      "G (PF) 1/16": { MajorDiameter: 7.723, Pitch: 0.907, TapDrillDiameter: 6.8 },
      "G (PF) 1/8": { MajorDiameter: 9.728, Pitch: 0.907, TapDrillDiameter: 8.7 },
      "G (PF) 1/4": { MajorDiameter: 13.157, Pitch: 1.337, TapDrillDiameter: 11.7 },
      "G (PF) 3/8": { MajorDiameter: 16.662, Pitch: 1.337, TapDrillDiameter: 15.2 },
      "G (PF) 1/2": { MajorDiameter: 20.955, Pitch: 1.814, TapDrillDiameter: 18.9 },
      "G (PF) 5/8": { MajorDiameter: 22.911, Pitch: 1.814, TapDrillDiameter: 20.9 },
      "G (PF) 3/4": { MajorDiameter: 26.441, Pitch: 1.814, TapDrillDiameter: 24.4 },
      "G (PF) 7/8": { MajorDiameter: 30.201, Pitch: 1.814, TapDrillDiameter: 28.1 },

      // Metric Coarse（粗牙）
      "M 6 x 1.0": { ThreadType: "Coarse", MajorDiameter: 6, Pitch: 1.0, TapDrillDiameter: 5 },
      "M 7 x 1.0": { ThreadType: "Coarse", MajorDiameter: 7, Pitch: 1.0, TapDrillDiameter: 6 },
      "M 8 x 1.25": { ThreadType: "Coarse", MajorDiameter: 8, Pitch: 1.25, TapDrillDiameter: 6.8 },
      "M 9 x 1.25": { ThreadType: "Coarse", MajorDiameter: 9, Pitch: 1.25, TapDrillDiameter: 7.8 },
      "M 10 x 1.5": { ThreadType: "Coarse", MajorDiameter: 10, Pitch: 1.5, TapDrillDiameter: 8.5 },
      "M 11 x 1.5": { ThreadType: "Coarse", MajorDiameter: 11, Pitch: 1.5, TapDrillDiameter: 9.5 },
      "M 12 x 1.75": { ThreadType: "Coarse", MajorDiameter: 12, Pitch: 1.75, TapDrillDiameter: 10.3 },
      "M 14 x 2.0": { ThreadType: "Coarse", MajorDiameter: 14, Pitch: 2.0, TapDrillDiameter: 12 },
      "M 16 x 2.0": { ThreadType: "Coarse", MajorDiameter: 16, Pitch: 2.0, TapDrillDiameter: 14 },

      // Metric Fine（細牙；你的資料維持用 MF 前綴）
      "MF 6 x 0.75": { ThreadType: "Fine", MajorDiameter: 6, Pitch: 0.75, TapDrillDiameter: 5.3 },
      "MF 7 x 0.75": { ThreadType: "Fine", MajorDiameter: 7, Pitch: 0.75, TapDrillDiameter: 6.3 },
      "MF 8 x 0.75": { ThreadType: "Fine", MajorDiameter: 8, Pitch: 0.75, TapDrillDiameter: 7.3 },
      "MF 8 x 1.0": { ThreadType: "Fine", MajorDiameter: 8, Pitch: 1.0, TapDrillDiameter: 7 },
      "MF 9 x 0.75": { ThreadType: "Fine", MajorDiameter: 9, Pitch: 0.75, TapDrillDiameter: 8.3 },
      "MF 9 x 1.0": { ThreadType: "Fine", MajorDiameter: 9, Pitch: 1.0, TapDrillDiameter: 8 },
      "MF 10 x 0.75": { ThreadType: "Fine", MajorDiameter: 10, Pitch: 0.75, TapDrillDiameter: 9.3 },
      "MF 10 x 1.0": { ThreadType: "Fine", MajorDiameter: 10, Pitch: 1.0, TapDrillDiameter: 9 },
      "MF 10 x 1.25": { ThreadType: "Fine", MajorDiameter: 10, Pitch: 1.25, TapDrillDiameter: 8.8 },
      "MF 11 x 0.75": { ThreadType: "Fine", MajorDiameter: 11, Pitch: 0.75, TapDrillDiameter: 10.3 },
      "MF 11 x 1.0": { ThreadType: "Fine", MajorDiameter: 11, Pitch: 1.0, TapDrillDiameter: 10 },
      "MF 12 x 1.0": { ThreadType: "Fine", MajorDiameter: 12, Pitch: 1.0, TapDrillDiameter: 11 },
      "MF 12 x 1.25": { ThreadType: "Fine", MajorDiameter: 12, Pitch: 1.25, TapDrillDiameter: 10.8 },
      "MF 12 x 1.5": { ThreadType: "Fine", MajorDiameter: 12, Pitch: 1.5, TapDrillDiameter: 10.5 },
      "MF 14 x 1.0": { ThreadType: "Fine", MajorDiameter: 14, Pitch: 1.0, TapDrillDiameter: 13 },
      "MF 14 x 1.25": { ThreadType: "Fine", MajorDiameter: 14, Pitch: 1.25, TapDrillDiameter: 12.8 },
      "MF 14 x 1.5": { ThreadType: "Fine", MajorDiameter: 14, Pitch: 1.5, TapDrillDiameter: 12.5 },
      "MF 15 x 1.0": { ThreadType: "Fine", MajorDiameter: 15, Pitch: 1.0, TapDrillDiameter: 14 },
      "MF 15 x 1.5": { ThreadType: "Fine", MajorDiameter: 15, Pitch: 1.5, TapDrillDiameter: 13.5 },
      "MF 16 x 1.0": { ThreadType: "Fine", MajorDiameter: 16, Pitch: 1.0, TapDrillDiameter: 15 },
      "MF 16 x 1.5": { ThreadType: "Fine", MajorDiameter: 16, Pitch: 1.5, TapDrillDiameter: 14.5 },
      "MF 17 x 1.0": { ThreadType: "Fine", MajorDiameter: 17, Pitch: 1.0, TapDrillDiameter: 16 },
      "MF 17 x 1.5": { ThreadType: "Fine", MajorDiameter: 17, Pitch: 1.5, TapDrillDiameter: 15.5 },
      "MF 18 x 1.0": { ThreadType: "Fine", MajorDiameter: 18, Pitch: 1.0, TapDrillDiameter: 17 },
      "MF 18 x 1.5": { ThreadType: "Fine", MajorDiameter: 18, Pitch: 1.5, TapDrillDiameter: 16.5 },
      "MF 18 x 2.0": { ThreadType: "Fine", MajorDiameter: 18, Pitch: 2.0, TapDrillDiameter: 16 },
      "MF 20 x 1.0": { ThreadType: "Fine", MajorDiameter: 20, Pitch: 1.0, TapDrillDiameter: 19 },
      "MF 20 x 1.5": { ThreadType: "Fine", MajorDiameter: 20, Pitch: 1.5, TapDrillDiameter: 18.5 },
      "MF 20 x 2.0": { ThreadType: "Fine", MajorDiameter: 20, Pitch: 2.0, TapDrillDiameter: 18 },
      "MF 22 x 1.0": { ThreadType: "Fine", MajorDiameter: 22, Pitch: 1.0, TapDrillDiameter: 21 },
      "MF 22 x 1.5": { ThreadType: "Fine", MajorDiameter: 22, Pitch: 1.5, TapDrillDiameter: 20.5 },
      "MF 22 x 2.0": { ThreadType: "Fine", MajorDiameter: 22, Pitch: 2.0, TapDrillDiameter: 20 },
      "MF 24 x 1.0": { ThreadType: "Fine", MajorDiameter: 24, Pitch: 1.0, TapDrillDiameter: 23 },
      "MF 24 x 1.5": { ThreadType: "Fine", MajorDiameter: 24, Pitch: 1.5, TapDrillDiameter: 22.5 },
      "MF 24 x 2.0": { ThreadType: "Fine", MajorDiameter: 24, Pitch: 2.0, TapDrillDiameter: 22 },
      "MF 25 x 1.0": { ThreadType: "Fine", MajorDiameter: 25, Pitch: 1.0, TapDrillDiameter: 24 },
      "MF 25 x 1.5": { ThreadType: "Fine", MajorDiameter: 25, Pitch: 1.5, TapDrillDiameter: 23.5 },
      "MF 25 x 2.0": { ThreadType: "Fine", MajorDiameter: 25, Pitch: 2.0, TapDrillDiameter: 23 },
      "MF 27 x 1.0": { ThreadType: "Fine", MajorDiameter: 27, Pitch: 1.0, TapDrillDiameter: 26 },
      "MF 27 x 1.5": { ThreadType: "Fine", MajorDiameter: 27, Pitch: 1.5, TapDrillDiameter: 25.5 },
      "MF 27 x 2.0": { ThreadType: "Fine", MajorDiameter: 27, Pitch: 2.0, TapDrillDiameter: 25 },
      "MF 28 x 1.0": { ThreadType: "Fine", MajorDiameter: 28, Pitch: 1.0, TapDrillDiameter: 27 },
      "MF 28 x 1.5": { ThreadType: "Fine", MajorDiameter: 28, Pitch: 1.5, TapDrillDiameter: 26.5 },
      "MF 28 x 2.0": { ThreadType: "Fine", MajorDiameter: 28, Pitch: 2.0, TapDrillDiameter: 26 },
      "MF 30 x 1.0": { ThreadType: "Fine", MajorDiameter: 30, Pitch: 1.0, TapDrillDiameter: 29 },
      "MF 30 x 1.5": { ThreadType: "Fine", MajorDiameter: 30, Pitch: 1.5, TapDrillDiameter: 28.5 },
      "MF 30 x 2.0": { ThreadType: "Fine", MajorDiameter: 30, Pitch: 2.0, TapDrillDiameter: 28 },
      "MF 32 x 1.5": { ThreadType: "Fine", MajorDiameter: 32, Pitch: 1.5, TapDrillDiameter: 30.5 },
      "MF 32 x 2.0": { ThreadType: "Fine", MajorDiameter: 32, Pitch: 2.0, TapDrillDiameter: 30 },
      "MF 33 x 1.0": { ThreadType: "Fine", MajorDiameter: 33, Pitch: 1.0, TapDrillDiameter: 31.5 },
      "MF 33 x 1.5": { ThreadType: "Fine", MajorDiameter: 33, Pitch: 1.5, TapDrillDiameter: 31.5 },
      "MF 33 x 2.0": { ThreadType: "Fine", MajorDiameter: 33, Pitch: 2.0, TapDrillDiameter: 31 },
      "MF 35 x 1.5": { ThreadType: "Fine", MajorDiameter: 35, Pitch: 1.5, TapDrillDiameter: 33.5 },
      "MF 36 x 1.5": { ThreadType: "Fine", MajorDiameter: 36, Pitch: 1.5, TapDrillDiameter: 34.5 },
      "MF 36 x 2.0": { ThreadType: "Fine", MajorDiameter: 36, Pitch: 2.0, TapDrillDiameter: 34 },
      "MF 39 x 1.5": { ThreadType: "Fine", MajorDiameter: 39, Pitch: 1.5, TapDrillDiameter: 37.5 },
      "MF 39 x 2.0": { ThreadType: "Fine", MajorDiameter: 39, Pitch: 2.0, TapDrillDiameter: 37 },
      "MF 40 x 1.5": { ThreadType: "Fine", MajorDiameter: 40, Pitch: 1.5, TapDrillDiameter: 38.5 },
      "MF 40 x 2.0": { ThreadType: "Fine", MajorDiameter: 40, Pitch: 2.0, TapDrillDiameter: 38 },
      "MF 42 x 1.5": { ThreadType: "Fine", MajorDiameter: 42, Pitch: 1.5, TapDrillDiameter: 40.5 },
      "MF 42 x 2.0": { ThreadType: "Fine", MajorDiameter: 42, Pitch: 2.0, TapDrillDiameter: 40 },
      "MF 45 x 1.5": { ThreadType: "Fine", MajorDiameter: 45, Pitch: 1.5, TapDrillDiameter: 43.5 },
      "MF 45 x 2.0": { ThreadType: "Fine", MajorDiameter: 45, Pitch: 2.0, TapDrillDiameter: 43 },
      "MF 48 x 1.5": { ThreadType: "Fine", MajorDiameter: 48, Pitch: 1.5, TapDrillDiameter: 46.5 },
      "MF 48 x 2.0": { ThreadType: "Fine", MajorDiameter: 48, Pitch: 2.0, TapDrillDiameter: 46 },
      "MF 50 x 1.5": { ThreadType: "Fine", MajorDiameter: 50, Pitch: 1.5, TapDrillDiameter: 48.5 },
      "MF 50 x 2.0": { ThreadType: "Fine", MajorDiameter: 50, Pitch: 2.0, TapDrillDiameter: 48 },
      "MF 52 x 2.0": { ThreadType: "Fine", MajorDiameter: 52, Pitch: 2.0, TapDrillDiameter: 50 },
      "MF 55 x 2.0": { ThreadType: "Fine", MajorDiameter: 55, Pitch: 2.0, TapDrillDiameter: 53 },
      "MF 56 x 2.0": { ThreadType: "Fine", MajorDiameter: 56, Pitch: 2.0, TapDrillDiameter: 54 },
      "MF 58 x 2.0": { ThreadType: "Fine", MajorDiameter: 58, Pitch: 2.0, TapDrillDiameter: 56 },
      "MF 60 x 2.0": { ThreadType: "Fine", MajorDiameter: 60, Pitch: 2.0, TapDrillDiameter: 58 },
      "MF 62 x 2.0": { ThreadType: "Fine", MajorDiameter: 62, Pitch: 2.0, TapDrillDiameter: 60 },
      "MF 64 x 2.0": { ThreadType: "Fine", MajorDiameter: 64, Pitch: 2.0, TapDrillDiameter: 62 },
      "MF 65 x 2.0": { ThreadType: "Fine", MajorDiameter: 65, Pitch: 2.0, TapDrillDiameter: 63 },
      "MF 68 x 2.0": { ThreadType: "Fine", MajorDiameter: 68, Pitch: 2.0, TapDrillDiameter: 66 },
      "MF 70 x 2.0": { ThreadType: "Fine", MajorDiameter: 70, Pitch: 2.0, TapDrillDiameter: 68 },
      "MF 72 x 2.0": { ThreadType: "Fine", MajorDiameter: 72, Pitch: 2.0, TapDrillDiameter: 70 },
      "MF 75 x 2.0": { ThreadType: "Fine", MajorDiameter: 75, Pitch: 2.0, TapDrillDiameter: 73 },
      "MF 76 x 2.0": { ThreadType: "Fine", MajorDiameter: 76, Pitch: 2.0, TapDrillDiameter: 74 },
      "MF 80 x 2.0": { ThreadType: "Fine", MajorDiameter: 80, Pitch: 2.0, TapDrillDiameter: 78 },

      // UNC/UNF/UNEF
      "UNC 1/2-13": { ThreadType: "UNC", MajorDiameter: 12.7, Pitch: 1.954, TapDrillDiameter: 10.8 },

      "UNF 1/4-28": { ThreadType: "UNF", MajorDiameter: 6.35, Pitch: 0.907, TapDrillDiameter: 5.5 },
      "UNF 5/16-24": { ThreadType: "UNF", MajorDiameter: 7.938, Pitch: 1.058, TapDrillDiameter: 6.9 },
      "UNF 3/8-24": { ThreadType: "UNF", MajorDiameter: 9.525, Pitch: 1.058, TapDrillDiameter: 8.5 },
      "UNF 7/16-20": { ThreadType: "UNF", MajorDiameter: 11.112, Pitch: 1.27, TapDrillDiameter: 9.9 },
      "UNF 1/2-20": { ThreadType: "UNF", MajorDiameter: 12.7, Pitch: 1.27, TapDrillDiameter: 11.5 },
      "UNF 9/16-18": { ThreadType: "UNF", MajorDiameter: 14.288, Pitch: 1.411, TapDrillDiameter: 12.9 },
      "UNF 5/8-18": { ThreadType: "UNF", MajorDiameter: 15.875, Pitch: 1.411, TapDrillDiameter: 14.5 },
      "UNF 3/4-16": { ThreadType: "UNF", MajorDiameter: 19.05, Pitch: 1.588, TapDrillDiameter: 17.5 },
      "UNF 7/8-14": { ThreadType: "UNF", MajorDiameter: 22.225, Pitch: 1.814, TapDrillDiameter: 20.5 },

      "UNEF 1/4-32": { ThreadType: "UNEF", MajorDiameter: 6.35, Pitch: 0.794, TapDrillDiameter: 5.6 },
      "UNEF 5/16-32": { ThreadType: "UNEF", MajorDiameter: 7.938, Pitch: 0.794, TapDrillDiameter: 7.2 },
      "UNEF 3/8-32": { ThreadType: "UNEF", MajorDiameter: 9.525, Pitch: 0.794, TapDrillDiameter: 8.8 },
      "UNEF 7/16-28": { ThreadType: "UNEF", MajorDiameter: 11.112, Pitch: 0.907, TapDrillDiameter: 10.2 },
      "UNEF 1/2-28": { ThreadType: "UNEF", MajorDiameter: 12.7, Pitch: 0.907, TapDrillDiameter: 11.8 },
      "UNEF 9/16-24": { ThreadType: "UNEF", MajorDiameter: 14.288, Pitch: 1.058, TapDrillDiameter: 13.3 },
      "UNEF 5/8-24": { ThreadType: "UNEF", MajorDiameter: 15.875, Pitch: 1.058, TapDrillDiameter: 14.9 },
      "UNEF 11/16-24": { ThreadType: "UNEF", MajorDiameter: 17.462, Pitch: 1.058, TapDrillDiameter: 16.4 },
      "UNEF 3/4-20": { ThreadType: "UNEF", MajorDiameter: 19.05, Pitch: 1.27, TapDrillDiameter: 17.8 },
      "UNEF 13/16-20": { ThreadType: "UNEF", MajorDiameter: 20.638, Pitch: 1.27, TapDrillDiameter: 19.4 },
      "UNEF 7/8-20": { ThreadType: "UNEF", MajorDiameter: 22.225, Pitch: 1.27, TapDrillDiameter: 21 },
      "UNEF 15/16-20": { ThreadType: "UNEF", MajorDiameter: 23.812, Pitch: 1.27, TapDrillDiameter: 22.6 },
      "UNEF 1-20": { ThreadType: "UNEF", MajorDiameter: 25.4, Pitch: 1.27, TapDrillDiameter: 24.2 },
      "UNEF 1 1/16-18": { ThreadType: "UNEF", MajorDiameter: 26.988, Pitch: 1.411, TapDrillDiameter: 25.6 },
      "UNEF 1 1/8-18": { ThreadType: "UNEF", MajorDiameter: 28.575, Pitch: 1.411, TapDrillDiameter: 27.2 },
      "UNEF 1 3/16-18": { ThreadType: "UNEF", MajorDiameter: 30.162, Pitch: 1.411, TapDrillDiameter: 28.8 },
      "UNEF 1 1/4-18": { ThreadType: "UNEF", MajorDiameter: 31.75, Pitch: 1.411, TapDrillDiameter: 30.4 },
      "UNEF 1 5/16-18": { ThreadType: "UNEF", MajorDiameter: 33.338, Pitch: 1.411, TapDrillDiameter: 32 },
      "UNEF 1 3/8-18": { ThreadType: "UNEF", MajorDiameter: 34.925, Pitch: 1.411, TapDrillDiameter: 33.6 },
      "UNEF 1 7/16-18": { ThreadType: "UNEF", MajorDiameter: 36.512, Pitch: 1.411, TapDrillDiameter: 35.1 },
      "UNEF 1 1/2-18": { ThreadType: "UNEF", MajorDiameter: 38.1, Pitch: 1.411, TapDrillDiameter: 36.7 },
      "UNEF 1 9/16-18": { ThreadType: "UNEF", MajorDiameter: 39.688, Pitch: 1.411, TapDrillDiameter: 38.3 },
      "UNEF 1 5/8-18": { ThreadType: "UNEF", MajorDiameter: 41.275, Pitch: 1.411, TapDrillDiameter: 39.9 },
      "UNEF 1 11/16-18": { ThreadType: "UNEF", MajorDiameter: 42.862, Pitch: 1.411, TapDrillDiameter: 41.5 },

      // ----- Heli-Coil Overrides（修正你原本的 HC-M* → HC M*；刪除重複鍵）-----
      "HC M5 x 0.8": { ThreadType: "HC", MajorDiameter: 6.04, Pitch: 0.8, TapDrillDiameter: 5.3 },  // HC 專用外徑/導孔
      "HC M6 x 1.0": { ThreadType: "HC", MajorDiameter: 7.3, Pitch: 1.0, TapDrillDiameter: 6.3 },
      "HC M7 x 1.0": { ThreadType: "HC", MajorDiameter: 8.3, Pitch: 1.0, TapDrillDiameter: 7.3 },
      "HC M8 x 1.0": { ThreadType: "HC", MajorDiameter: 9.3, Pitch: 1.0, TapDrillDiameter: 8.3 },
      "HC M8 x 1.25": { ThreadType: "HC", MajorDiameter: 9.624, Pitch: 1.25, TapDrillDiameter: 8.4 },
      "HC M9 x 1.0": { ThreadType: "HC", MajorDiameter: 10.3, Pitch: 1.0, TapDrillDiameter: 9.3 },
      "HC M9 x 1.25": { ThreadType: "HC", MajorDiameter: 10.624, Pitch: 1.25, TapDrillDiameter: 9.4 },
      "HC M10 x 1.0": { ThreadType: "HC", MajorDiameter: 11.3, Pitch: 1.0, TapDrillDiameter: 10.3 },
      "HC M10 x 1.25": { ThreadType: "HC", MajorDiameter: 11.624, Pitch: 1.25, TapDrillDiameter: 10.4 },
      "HC M10 x 1.5": { ThreadType: "HC", MajorDiameter: 11.948, Pitch: 1.5, TapDrillDiameter: 10.4 },
      "HC M11 x 1.0": { ThreadType: "HC", MajorDiameter: 12.3, Pitch: 1.0, TapDrillDiameter: 11.3 },
      "HC M11 x 1.5": { ThreadType: "HC", MajorDiameter: 12.948, Pitch: 1.5, TapDrillDiameter: 11.4 },
      "HC M12 x 1.0": { ThreadType: "HC", MajorDiameter: 13.3, Pitch: 1.0, TapDrillDiameter: 12.3 }
    }; // 用意：HC 如有特別導孔/外徑，就以 HC 鍵覆寫；若缺，程式回退用對應公制並套公式

    /* ---------- 系列（M/MF/HC）判斷 ---------- */
    // 公制粗牙表（直徑→對應粗牙螺距），用於判斷 M/MF（當字串本身是 MF 時直接視為 MF）
    const coarsePitch = { 6: 1.0, 7: 1.0, 8: 1.25, 9: 1.25, 10: 1.5, 11: 1.5, 12: 1.75, 14: 2.0, 15: 2.0, 16: 2.0, 17: 2.0, 18: 2.5, 20: 2.5, 22: 2.5, 24: 3.0 };

    // function seriesOfSize(s) {
    //   if (/^(HC|Heli[\s-]?Coil)/i.test(s)) return 'HC'; // HC 前綴直接視為 HC

    //   const m = baseMetricOf(s).match(/^(M|MF)\s*([0-9.]+)(?:\s*x\s*([0-9.]+))?/i);
    //   if (!m) return 'OTHER';
    //   const label = (m[1] || '').toUpperCase();
    //   const dia = Number(m[2]);
    //   const pitch = m[3] ? Number(m[3]) : null;

    //   if (label === 'MF') return 'MF';        // MF 前綴直接視為細牙
    //   if (pitch == null) return 'M';          // 未寫螺距預設粗牙
    //   const cp = coarsePitch[dia];
    //   if (cp == null) return 'MF';            // 不在表內，偏細牙化
    //   return Math.abs(pitch - cp) < 1e-6 ? 'M' : 'MF';
    // } // 用意：能同時處理 "M ..." 與 "MF ..." 以及 "HC ..." 3 種前綴

    function seriesOfSize(s) {
      // 1) HC：一律視為 HC
      if (/^(HC|Heli[\s-]?Coil)/i.test(s)) return 'HC';

      // 2) 公制 M / MF：沿用你的粗牙表邏輯
      const m = baseMetricOf(s).match(/^(M|MF)\s*([0-9.]+)(?:\s*x\s*([0-9.]+))?/i);
      if (m) {
        const label = (m[1] || '').toUpperCase();
        const dia = Number(m[2]);
        const pitch = m[3] ? Number(m[3]) : null;

        if (label === 'MF') return 'MF';        // MF 前綴直接 MF
        if (pitch == null) return 'M';          // 未寫螺距 → 粗牙
        const cp = coarsePitch[dia];
        if (cp == null) return 'MF';            // 不在表內 → 當細牙
        return Math.abs(pitch - cp) < 1e-6 ? 'M' : 'MF';
      }

      // 3) 新增 Unified 系列辨識
      if (/^UNC\b/i.test(s)) return 'UNC';
      if (/^UNF\b/i.test(s)) return 'UNF';
      if (/^UNEF\b/i.test(s)) return 'UNEF';

      return 'OTHER';
    }

    /* ---------- Family / Size / Insert 清單組裝 ---------- */
    function getCurrentFamilyKey() {
      const mode = document.getElementById('threadMode').value;
      if (mode === 'parallel') {
        const fam = document.getElementById('selectParallelFamily').value;
        return fam || null;                    // parallel60 | parallel55
      } else if (mode === 'tapered') {
        const fam = document.getElementById('selectTaper').value; // '55' | '60'
        if (fam === '55') return 'tapered55';
        if (fam === '60') return 'tapered60';
      }
      return null;
    } // 用意：由 UI 狀態判定目前家族 key

    function getFamilyInserts(key) { return key && toolGroups[key] ? toolGroups[key] : []; } // 取家族 insert 清單
    function getFamilySizes(key) {
      const inserts = getFamilyInserts(key);  // 集合此家族所有 insert 支援尺寸
      const set = new Set();
      inserts.forEach(ins => (toolThreadMap[ins.v] || []).forEach(s => set.add(s)));
      return Array.from(set);
    } // 用意：由 insert→sizes 反推整個 family 的尺寸池

    function populateInsertSelect(list, selectedValue) {
      const el = document.getElementById('selectTool');
      el.innerHTML = '';
      const def = document.createElement('option');
      def.value = ''; def.disabled = true; def.selected = !selectedValue; def.textContent = 'Select Insert';
      el.appendChild(def);
      list.forEach(o => {
        const op = document.createElement('option');
        op.value = o.v; op.textContent = o.t; op.style.fontWeight = 'bold';
        if (selectedValue && selectedValue === o.v) op.selected = true;
        el.appendChild(op);
      });
    } // 用意：重建 insert 下拉

    function populateSizeSelect(list, selectedValue) {
      const el = document.getElementById('selectThreadSize');
      el.innerHTML = '';
      const def = document.createElement('option');
      def.value = ''; def.disabled = true; def.selected = !selectedValue; def.textContent = 'Select thread size';
      el.appendChild(def);
      (list || []).forEach(s => {
        const op = document.createElement('option');
        op.value = s; op.textContent = s;
        if (selectedValue && selectedValue === s) op.selected = true;
        el.appendChild(op);
      });
    } // 用意：重建尺寸下拉（可維持原選擇）

    // 依 Series 過濾尺寸（M/MF 直過濾；HC 以底層公制轉 HC 顯示）
    function filterSizesBySeries(sizes, series) {
      if (!series) return sizes;
      if (series === 'HC') {
        const hcSet = new Set();
        sizes.filter(isMetricSize).forEach(s => hcSet.add(hcOf(s)));
        return Array.from(hcSet);
      }
      return sizes.filter(s => seriesOfSize(s) === series);
    } // 用意：從 family 尺寸池產生符合系列的顯示清單

    // 依 Series 過濾 insert：M/MF 需支援該系列尺寸；HC 需支援任一「公制尺寸」
    function filterInsertsBySeries(inserts, series) {
      if (!series) return inserts;
      return inserts.filter(ins => {
        const sizes = toolThreadMap[ins.v] || [];
        if (series === 'HC') return sizes.some(isMetricSize);
        return sizes.some(sz => seriesOfSize(sz) === series);
      });
    } // 用意：只讓能做對應系列的 insert 留下

    /* ---------- UI 事件：Series/Family/Size/Insert ---------- */
    function onSeriesChange() {
      const key = getCurrentFamilyKey();
      const series = document.getElementById('threadSeries').value;

      const sizes = filterSizesBySeries(getFamilySizes(key), series);
      populateSizeSelect(sizes, null);         // 重建尺寸

      const inserts = filterInsertsBySeries(getFamilyInserts(key), series);
      populateInsertSelect(inserts, null);     // 重建 insert

      document.getElementById('toolDiameter').value = '';          // 清幾何欄位
      ['od', 'tapDrill', 'pitch', 'threadInfo'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    } // 用意：切換系列時，同步過濾尺寸與 insert

    function updateInsertList() {
      const key = getCurrentFamilyKey();
      const familyInserts = getFamilyInserts(key);

      const seriesWrap = document.getElementById('seriesWrap');
      const seriesSel = document.getElementById('threadSeries');
      const showSeries = (key === 'parallel60');   // 只有公制 60° 才需要 M/MF/HC
      seriesWrap.style.display = showSeries ? '' : 'none';
      if (!showSeries && seriesSel) seriesSel.selectedIndex = 0;

      const selectedSeries = showSeries ? (seriesSel.value || '') : '';
      const sizes = filterSizesBySeries(getFamilySizes(key), selectedSeries);
      const inserts = filterInsertsBySeries(familyInserts, selectedSeries);

      populateInsertSelect(inserts, null);
      populateSizeSelect(sizes, null);

      document.getElementById('toolDiameter').value = '';
      ['od', 'tapDrill', 'pitch', 'threadInfo'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    } // 用意：選擇 Family 後，建立對應的 insert/size 清單，並控制 Series 顯示

    // function onInsertChange() {
    //   const toolCode = document.getElementById('selectTool').value;
    //   const Dc = getDcFromTool(toolCode);
    //   document.getElementById('toolDiameter').value = Dc || '';

    //   const series = document.getElementById('threadSeries').value;
    //   const raw = toolThreadMap[toolCode] || [];
    //   let allowed = [];
    //   if (series === 'HC') {
    //     allowed = raw.filter(isMetricSize).map(hcOf);            // 轉成 HC 顯示
    //   } else if (series === 'M' || series === 'MF') {
    //     allowed = raw.filter(sz => seriesOfSize(sz) === series); // 保留該系列尺寸
    //   } else {
    //     allowed = raw.slice();                                   // 未選系列 → 全列
    //   }

    //   const sizeSel = document.getElementById('selectThreadSize');
    //   const currentSize = sizeSel.value;
    //   populateSizeSelect(allowed, allowed.includes(currentSize) ? currentSize : null);

    //   if (!allowed.includes(currentSize)) {
    //     ['od','tapDrill','pitch','threadInfo'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
    //   } else {
    //     updateThreadFields(currentSize);
    //   }
    // } // 用意：選刀後，限定可做的尺寸；不相容就清空幾何

    function onInsertChange() {
      const toolCode = document.getElementById('selectTool').value;
      const Dc = getDcFromTool(toolCode);
      document.getElementById('toolDiameter').value = Dc || '';

      const series = document.getElementById('threadSeries').value;
      const raw = toolThreadMap[toolCode] || [];
      let allowed = [];

      if (series === 'HC') {
        allowed = raw.filter(isMetricSize).map(hcOf); // HC 顯示
      } else if (['M', 'MF', 'UNC', 'UNF', 'UNEF'].includes(series)) {
        allowed = raw.filter(sz => seriesOfSize(sz) === series); // 這行支援全部系列
      } else {
        allowed = raw.slice(); // 未選系列 → 全列
      }

      const sizeSel = document.getElementById('selectThreadSize');
      const currentSize = sizeSel.value;
      populateSizeSelect(allowed, allowed.includes(currentSize) ? currentSize : null);

      if (!allowed.includes(currentSize)) {
        ['od', 'tapDrill', 'pitch', 'threadInfo'].forEach(id => {
          const el = document.getElementById(id); if (el) el.value = '';
        });
      } else {
        updateThreadFields(currentSize);
      }
    }

    function onThreadSizeChange() {
      const size = document.getElementById('selectThreadSize').value;
      updateThreadFields(size);                                   // 帶幾何

      const key = getCurrentFamilyKey();
      const series = document.getElementById('threadSeries').value;
      const matchSize = (series === 'HC') ? baseMetricOf(size) : size; // HC 用底層公制來查相容 insert

      const familyInserts = filterInsertsBySeries(getFamilyInserts(key), series);
      const filtered = familyInserts.filter(ins => (toolThreadMap[ins.v] || []).includes(matchSize));

      const toolSel = document.getElementById('selectTool');
      const prev = toolSel.value;
      populateInsertSelect(filtered, filtered.some(i => i.v === prev) ? prev : null);

      if (!filtered.some(i => i.v === prev)) {
        document.getElementById('toolDiameter').value = '';
      } else {
        const Dc = getDcFromTool(toolSel.value);
        document.getElementById('toolDiameter').value = Dc || '';
      }
    } // 用意：選尺寸後，反向過濾出能做該尺寸的 insert

    /* ---------- 依 key 取資料 + 帶欄位 ---------- */
    // 取得指定 key 的 thread 資料：
    // - 直接命中 threadData 就用
    // - 若是 HC* 且 DB 沒資料：回退用該 HC 的「底層公制」資料推算（TapDrill 無資料時用 60° 牙理論公式）
    function getThreadDataForKey(key) {
      if (threadData[key]) return threadData[key];

      if (/^(HC|Heli[\s-]?Coil)\s*/i.test(key)) {
        const base = baseMetricOf(key);
        const d0 = threadData[base];
        if (!d0) return {}; // 連基礎公制也沒有就放空

        const obj = { ...d0 }; // 先沿用公制資料
        if (obj.TapDrillDiameter == null && obj.MajorDiameter != null && obj.Pitch != null) {
          // 60° 牙理論內徑：Minor ≈ Major − 1.08253×P
          obj.TapDrillDiameter = +(obj.MajorDiameter - 1.08253 * obj.Pitch).toFixed(3);
        }
        return obj;
      }
      return {};
    } // 用意：HC 鍵缺資料則回退用公制＋公式推導導孔

    function updateThreadFields(key) {
      const data = getThreadDataForKey(key);
      if (!data) return;

      if (data.Pitch != null) document.getElementById('pitch').value = data.Pitch;
      if (data.MajorDiameter != null) document.getElementById('od').value = data.MajorDiameter;
      if (data.TapDrillDiameter != null) document.getElementById('tapDrill').value = data.TapDrillDiameter;

      const info = `Thread: ${key}
Major Diameter: ${data.MajorDiameter ?? '-'} mm
Pitch: ${data.Pitch ?? '-'} mm
Tap Drill Diameter: ${data.TapDrillDiameter ?? '-'} mm`;
      document.getElementById('threadInfo').value = info;

      // 讓主程式的 updateDepthAuto 依你現場規則帶切深
      if (typeof updateDepthAuto === 'function') updateDepthAuto();
    } // 用意：把 threadData 的幾何值帶進輸入框，並觸發切深預設
  </script>

  <!-- 後備 onModeChange（外部檔若未提供時才註冊） + 初始化 -->
  <script>
    if (typeof onModeChange !== 'function') {
      window.onModeChange = function () {
        const mode = document.getElementById('threadMode').value;
        const pWrap = document.getElementById('parallelWrap');
        const tWrap = document.getElementById('taperWrap');

        // 清空下游
        document.getElementById('selectTool').innerHTML = '<option value="" disabled selected>Select Insert</option>';
        document.getElementById('selectThreadSize').innerHTML = '<option value="" disabled selected>Select thread size</option>';
        document.getElementById('toolDiameter').value = '';
        ['od', 'tapDrill', 'pitch', 'threadInfo'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const handEl = document.getElementById('threadHand'); if (handEl) handEl.selectedIndex = 0;

        // reset families + series
        const pf = document.getElementById('selectParallelFamily'); if (pf) pf.selectedIndex = 0;
        const tp = document.getElementById('selectTaper'); if (tp) tp.selectedIndex = 0;
        const seriesSel = document.getElementById('threadSeries'); if (seriesSel) seriesSel.selectedIndex = 0;
        document.getElementById('seriesWrap').style.display = 'none';

        updateSpindleSpeed();

        if (mode === 'parallel') { pWrap.style.display = ''; tWrap.style.display = 'none'; }
        else if (mode === 'tapered') { pWrap.style.display = 'none'; tWrap.style.display = ''; }
        else { pWrap.style.display = 'none'; tWrap.style.display = 'none'; }
      };
    }

    // 初始化
    window.addEventListener('load', () => {
      updatePassInputs();
      if (typeof onModeChange === 'function') onModeChange();
      updateDepthAuto();
      const pitchEl = document.getElementById('pitch');
      if (pitchEl) pitchEl.addEventListener('input', updateDepthAuto);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>  